# Spring事务简述

Java平台提供了许多能够管理数据库事务管理的API，例如：

* JDBC事务管理
* 基于JTA的分布式事务管理

这些API提供的事务管理与数据访问是强耦合的

以JDBC为例，通过Connection对象获取语句访问数据库，同时通过Connection对象进行事务管理，这导致数据访问代码和事务管理的迪马的可重用性降低，并且事务管理的代码在数据访问层和业务服务层到处散落。

针对直接使用这些事务管理API带来的弊端，Spring提供了事务框架，让事务管理的关注点和数据访问的关注点分离。

Spring的事务框架将 connection通过ThreadLocal绑定到当前线程上，让处在同一事务中的不同dao数据访问方法公用同一个connection对象，保证它们处于同一事务下。

Spring的事务后向包括三个主要接口：

* PlatformTransactionManager：界定事务边界
* TransactionDefinition：负责定义事务相关属性，如隔离级别、传播行为等
* TransactionStatus：负责的事务状态

# TransactionDefinition

TransactionDefinition定义如下:

~~~java
public interface TransactionDefinition {
	int PROPAGATION_REQUIRED = 0;
	int PROPAGATION_SUPPORTS = 1;
	int PROPAGATION_MANDATORY = 2;
	int PROPAGATION_REQUIRES_NEW = 3;
	int PROPAGATION_NOT_SUPPORTED = 4;
	int PROPAGATION_NEVER = 5;
	int PROPAGATION_NESTED = 6;
	int ISOLATION_DEFAULT = -1;
	int ISOLATION_READ_UNCOMMITTED = 1;
	int ISOLATION_READ_COMMITTED = 2;
	int ISOLATION_REPEATABLE_READ = 4;
	int ISOLATION_SERIALIZABLE = 8;
	int TIMEOUT_DEFAULT = -1;

	default int getPropagationBehavior() {
		return PROPAGATION_REQUIRED;
	}

	default int getIsolationLevel() {
		return ISOLATION_DEFAULT;
	}

	default int getTimeout() {
		return TIMEOUT_DEFAULT;
	}

	default boolean isReadOnly() {
		return false;
	}


	default String getName() {
		return null;
	}

	static TransactionDefinition withDefaults() {
		return StaticTransactionDefinition.INSTANCE;
	}
}
~~~

TransactionDefinition主要定义了可以指定的事务属性：

* 事务的传播行为
  * ISOLATION_DEFAULT：数据库的默认隔离级别，通常是读已提交
  * ISOLATION_READ_UNCOMMITTED:读未提交
  * ISOLATION_READ_COMMITTED :读已提交
  * ISOLATION_REPEATABLE_READ:不可重复读
  * ISOLATION_SERIALIZABLE :可串行化
* 事务隔离级别
  * PROPAGATION_REQUIRED
  * PROPAGATION_SUPPORTS
  * PROPAGATION_MANDATORY
  * PROPAGATION_REQUIRES_NEW
  * PROPAGATION_NOT_SUPPORTED
  * PROPAGATION_NEVER
  * PROPAGATION_NESTED
* 是否为只读事务
* 事务的超时时间















# Spring事务管理

spring通过aop提供了事务管理

## maven依赖

~~~xml
<!--做spring事务用到的-->
<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-tx</artifactId>
    <version>5.2.5.RELEASE</version>
</dependency>
<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-jdbc</artifactId>
    <version>5.2.5.RELEASE</version>
</dependency>
~~~

## Spring事务传播行为

事务传播行为（propagation behavior）指的就是当一个事务方法被另一个事务方法调用时，这个事务方法应该如何进行。

spring提供了7中事务行为，其中最常用：

* Propagation.REQUIRED(默认的事务传播)
  如果当前存在事务，则加入该事务，如果当前不存在事务，则创建一个新的事务。

* Propagation.SUPPORTS
  如果当前存在事务，则加入该事务；如果当前不存在事务，则以非事务的方式继续运行。

* Propagation.MANDATORY
  如果当前存在事务，则加入该事务；如果当前不存在事务，则抛出异常。

* Propagation.REQUIRES_NEW
  重新创建一个新的事务，如果当前存在事务，延缓当前的事务。

* Propagation.NOT_SUPPORTED
  以非事务的方式运行，如果当前存在事务，暂停当前的事务。

* Propagation.NEVER
  以非事务的方式运行，如果当前存在事务，则抛出异常。

* Propagation.NESTED
  如果没有，就新建一个事务；如果有，就在当前事务中嵌套其他事务。

Propagation.REQUIRED, Propagation.REQUIRES_NEW是最常用的两张事务传播行为

## 非注解配置

~~~xml
<!--配置事务管理器类-->
<bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
    <!--这里为事务管理器类提供数据源，数据源会在mybatis与spring整合时，由spring提供-->
    <property name="dataSource" ref=""/>
</bean>

<!--配置事务aop-->
<aop:config>
    <!--配置切点-->
    <aop:pointcut id="allMethodPointcut" expression="execution(* com.bjpn..service.*.*(..))"/>
    <!--配置通知器-->
    <aop:advisor advice-ref="txAdvice" pointcut-ref="allMethodPointcut"/>
</aop:config>

<!--配置事务传播行为-->
<tx:advice id="txAdvice">
    <tx:attributes>
        <tx:method name="add*" propagation="REQUIRED" rollback-for="Exception"/>
        <tx:method name="save*" propagation="REQUIRED" rollback-for="Exception"/>
        <tx:method name="edit*" propagation="REQUIRED" rollback-for="Exception"/>
        <tx:method name="update*" propagation="REQUIRED" rollback-for="Exception"/>
        <tx:method name="delete*" propagation="REQUIRED" rollback-for="Exception"/>
        <tx:method name="remove*" propagation="REQUIRED" rollback-for="Exception"/>
        <tx:method name="modify*" propagation="REQUIRED" rollback-for="Exception"/>
        <tx:method name="get*" propagation="SUPPORTS" read-only="true"/>
        <tx:method name="find*" propagation="SUPPORTS" read-only="true"/>
    </tx:attributes>
</tx:advice>
~~~



## 注解配置

~~~xml
<!-- 可通过注解控制事务 -->
<tx:annotation-driven transaction-manager="transactionManager" />
<bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
    <property name="dataSource" ref="" />   
</bean>
~~~





~~~java
//标示当前类需要事务
@Transactional
@Service
public class UserServiceImpl implements UserService {
    @Override
     @Transactional(propagation = Propagation.REQUIRED,rollbackFor = {Exception.class})
    public boolean transferMoney(String code, String code1, double money) {
        //加钱  修改数据库
        //减钱  修改数据库
        //同时完成  业务才完成
        return false;
    }

    @Override
    //配置当前方法的事务  查询事务  可以有  也可以没有
    @Transactional(propagation = Propagation.SUPPORTS,readOnly = true)
    public void findAll() {

    }

    @Override
    //没有事务会创建事务  有多个事务会合并事务
    @Transactional(propagation = Propagation.REQUIRED,rollbackFor = {Exception.class})
    public void addMoney() {

    }
}
~~~









